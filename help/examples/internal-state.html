<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Internal State - &lt;ck-editable-array&gt;</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 1300px; margin: 40px auto; padding: 0 20px; }
    nav a { color: inherit; text-decoration: none; }
    .example { margin: 28px 0; padding: 18px; border: 1px solid #ddd; border-radius: 10px; }
    .demo { padding: 14px; background: #f5f5f5; border-radius: 8px; margin: 12px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .panel { border: 1px solid #ddd; border-radius: 10px; padding: 12px; background: #fff; }
    .code { background: #111; color: #eaeaea; padding: 12px; border-radius: 10px; overflow-x: auto; }
    button { padding: 6px 10px; }
    .small { color: #444; font-size: 0.92rem; }
  </style>
</head>
<body>
  <nav><a href="../index.html">← Back to Documentation</a></nav>

  <h1>Internal State & Debugging</h1>
  <p class="small">
    The component’s internal state is mostly private, but the shadow DOM is <code>open</code>, so you can inspect observable state:
    row <code>data-mode</code>, row classes, hidden <code>isDeleted</code> checkbox state, and the emitted events.
  </p>

  <div class="example" id="inspector">
    <h2>1) State inspector (shadow DOM snapshot)</h2>
    <div class="row">
      <div class="panel">
        <button id="setData">Set data</button>
        <button id="toggleEdit0">Toggle edit row 0</button>
        <button id="delete0">Delete/Restore row 0</button>
        <button id="save">Save current</button>
        <button id="cancel">Cancel current</button>
        <p class="small">All buttons invoke the component via its shadow DOM action buttons.</p>
      </div>
      <div class="panel">
        <h3 style="margin-top:0;">Snapshot</h3>
        <pre class="code" style="margin:0;"><code id="snapshotOut"></code></pre>
      </div>
    </div>

    <div class="demo">
      <ck-editable-array id="inspectorEl" name="debug" datachange-mode="debounced" datachange-debounce="250">
        <template slot="display">
          <div><strong>Title:</strong> <span data-bind="title"></span></div>
          <div><strong>Meta:</strong> <span data-bind="meta.tag"></span></div>
          <div><strong>isDeleted:</strong> <span data-bind="isDeleted"></span></div>
        </template>
        <template slot="edit">
          <label>Title <input data-bind="title" /></label>
          <label>Meta tag <input data-bind="meta.tag" /></label>
        </template>
      </ck-editable-array>
    </div>
  </div>

  <div class="example" id="events">
    <h2>2) Event firing visualization</h2>
    <p class="small">Logs events in the order they fire, including payload details.</p>
    <pre class="code" style="margin:0; max-height: 320px;"><code id="eventsOut"></code></pre>
  </div>

  <script type="module">
    import '../../dist/ck-editable-array/ck-editable-array.esm.js';

    const el = document.querySelector('#inspectorEl');
    const snapshotOut = document.querySelector('#snapshotOut');
    const eventsOut = document.querySelector('#eventsOut');

    const logs = [];
    const log = (name, detail) => {
      const line = {
        time: new Date().toLocaleTimeString(),
        event: name,
        detail
      };
      logs.unshift(line);
      eventsOut.textContent = logs.slice(0, 25).map((l) => {
        return `[${l.time}] ${l.event} ${JSON.stringify(l.detail)}`;
      }).join('\n');
    };

    el.addEventListener('datachanged', (e) => log('datachanged', { count: e.detail.data.length }));
    el.addEventListener('rowchanged', (e) => log('rowchanged', e.detail));
    el.addEventListener('beforetogglemode', (e) => log('beforetogglemode', { ...e.detail, cancelable: true }));
    el.addEventListener('aftertogglemode', (e) => log('aftertogglemode', e.detail));

    function getRowsSnapshot() {
      const root = el.shadowRoot;
      if (!root) return { shadow: null };

      const rows = Array.from(root.querySelectorAll('[data-row]'));
      return {
        data: el.data,
        rows: rows.map((r) => {
          const idx = Number(r.getAttribute('data-row'));
          const mode = r.getAttribute('data-mode');
          const deleted = r.classList.contains('ck-deleted');
          const editDisabled = Boolean(r.querySelector('[data-action="toggle"]')?.disabled);
          const checkbox = r.querySelector('input[type="checkbox"][data-bind="isDeleted"]');
          return {
            index: idx,
            mode,
            deleted,
            editDisabled,
            hiddenIsDeletedCheckboxChecked: checkbox ? checkbox.checked : null
          };
        })
      };
    }

    function renderSnapshot() {
      snapshotOut.textContent = JSON.stringify(getRowsSnapshot(), null, 2);
    }

    function clickRowAction(rowIndex, action) {
      const root = el.shadowRoot;
      const btn = root?.querySelector(`[data-row="${rowIndex}"] [data-action="${action}"]`);
      btn?.click();
      renderSnapshot();
    }

    document.querySelector('#setData').addEventListener('click', () => {
      el.data = [
        { title: 'First', meta: { tag: 'alpha' }, isDeleted: false },
        { title: 'Second', meta: { tag: 'beta' }, isDeleted: false }
      ];
      renderSnapshot();
    });

    document.querySelector('#toggleEdit0').addEventListener('click', () => clickRowAction(0, 'toggle'));
    document.querySelector('#delete0').addEventListener('click', () => clickRowAction(0, 'delete'));

    document.querySelector('#save').addEventListener('click', () => {
      const root = el.shadowRoot;
      const active = root?.querySelector('[data-row][data-mode="edit"]');
      const idx = active?.getAttribute('data-row');
      if (idx != null) clickRowAction(Number(idx), 'save');
    });

    document.querySelector('#cancel').addEventListener('click', () => {
      const root = el.shadowRoot;
      const active = root?.querySelector('[data-row][data-mode="edit"]');
      const idx = active?.getAttribute('data-row');
      if (idx != null) clickRowAction(Number(idx), 'cancel');
    });

    // Initialize
    el.data = [{ title: 'Hello', meta: { tag: 'init' } }];
    renderSnapshot();
    log('ready', {});

    // Keep snapshot fresh after changes
    el.addEventListener('aftertogglemode', renderSnapshot);
    el.addEventListener('datachanged', renderSnapshot);
    el.addEventListener('rowchanged', renderSnapshot);
  </script>
</body>
</html>
